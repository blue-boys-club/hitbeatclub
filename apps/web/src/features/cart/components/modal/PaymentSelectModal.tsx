"use client";

// import { randomUUID } from "crypto";
import { v4 as uuidv4 } from "uuid";
import { useCallback, useState, useRef, useEffect } from "react";
import * as PortOne from "@portone/browser-sdk/v2";
import * as Popup from "@/components/ui/Popup";
import { cn } from "@/common/utils";
import { type PaymentError, type PaymentResponse } from "@portone/browser-sdk/v2";
import { PORTONE_STORE_ID } from "@/lib/payment.constant";
import { PORTONE_CHANNEL_KEY } from "@/lib/payment.constant";
import type { PaymentOrderResponse } from "@hitbeatclub/shared-types/payment";
import { useCreatePaymentOrderMutation } from "@/apis/payment/mutations/useCreatePaymentOrderMutation";
import { useCompletePaymentOrderMutation } from "@/apis/payment/mutations/useCompletePaymentOrderMutation";
import { AxiosError } from "axios";
import { useQuery } from "@tanstack/react-query";
import { getUserMeQueryOption } from "@/apis/user/query/user.query-option";
import { useExchangeRateLatestQueryOptions } from "@/apis/exchange-rate/query/exchange-rate.query-options";

export type CheckoutItem = {
	productId: number;
	licenseId: number;
	imageUrl: string;
	title: string;
	price: number;
};

/**
 * Í≤∞Ï†ú ÏàòÎã® ÏÑ†ÌÉù Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏ Props
 */
interface PaymentSelectModalProps {
	/** Ï¥ù Í≤∞Ï†ú Í∏àÏï° */
	total: number;
	/** Ï£ºÎ¨∏Î™Ö */
	orderName: string;
	/** Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏïÑÏù¥ÌÖú Î™©Î°ù */
	checkoutItems: CheckoutItem[];
	/** Î™®Îã¨ Ïó¥Î¶º ÏÉÅÌÉú */
	open: boolean;
	/** Î™®Îã¨ Ïó¥Î¶º/Îã´Ìûò ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏΩúÎ∞± */
	onOpenChange: (open: boolean) => void;
	/** Í≤∞Ï†ú ÏôÑÎ£å ÏΩúÎ∞± */
	onPaymentComplete?: (result: PaymentOrderResponse) => void;
	/** Í≤∞Ï†ú Ïã§Ìå® ÏΩúÎ∞± */
	onPaymentError?: (error: { message: string; code: string }) => void;
}

type PaymentMethod = {
	id: string;
	name: string;
	method: string;
	icon: string | React.ReactNode;
};

type EasyPayProvider = {
	id: string;
	name: string;
	bgColor: string;
	icon: string;
	availablePayMethods?: string[];
	checkIsAvailable?: () => boolean;
};

const paymentMethods: PaymentMethod[] = [
	{
		id: "card",
		name: "Ïã†Ïö©/Ï≤¥ÌÅ¨Ïπ¥Îìú",
		method: "CARD",
		icon: "üí≥",
	},
	// {
	// 	id: "virtual-account",
	// 	name: "Í∞ÄÏÉÅÍ≥ÑÏ¢å",
	// 	method: "VIRTUAL_ACCOUNT",
	// 	icon: "üè¶",
	// },
	{
		id: "transfer",
		name: "Í≥ÑÏ¢åÏù¥Ï≤¥",
		method: "TRANSFER",
		icon: "üí∏",
	},
	// {
	// 	id: "mobile",
	// 	name: "Ìú¥ÎåÄÌè∞ ÏÜåÏï°Í≤∞Ï†ú",
	// 	method: "MOBILE",
	// 	icon: "üì±",
	// },
	// {
	// 	id: "gift-certificate",
	// 	name: "ÏÉÅÌíàÍ∂å Í≤∞Ï†ú",
	// 	method: "GIFT_CERTIFICATE",
	// 	icon: "üéÅ",
	// },
	{
		id: "paypal",
		name: "ÌéòÏù¥Ìåî",
		method: "PAYPAL",
		icon: "üí≥",
	},
];

/**
 * Í≤∞Ï†ú ÏàòÎã® ÏÑ†ÌÉù Î∞è Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ Ï≤òÎ¶¨ÌïòÎäî Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏ÏûÖÎãàÎã§.
 *
 * @param total Ï¥ù Í≤∞Ï†ú Í∏àÏï°
 * @param orderName Ï£ºÎ¨∏Î™Ö
 * @param checkoutItems Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏïÑÏù¥ÌÖú Î™©Î°ù
 * @param open Î™®Îã¨ Ïó¥Î¶º ÏÉÅÌÉú
 * @param onOpenChange Î™®Îã¨ Ïó¥Î¶º/Îã´Ìûò ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏΩúÎ∞±
 * @param onPaymentComplete Í≤∞Ï†ú ÏôÑÎ£å ÏΩúÎ∞±
 * @param onPaymentError Í≤∞Ï†ú Ïã§Ìå® ÏΩúÎ∞±
 */
export const PaymentSelectModal = ({
	total,
	orderName,
	checkoutItems,
	open,
	onOpenChange,
	onPaymentComplete,
	onPaymentError,
}: PaymentSelectModalProps) => {
	const [selectedMethod, setSelectedMethod] = useState<PaymentMethod | null>(null);
	const [selectedEasyPayProvider, setSelectedEasyPayProvider] = useState<EasyPayProvider | null>(null);
	const [isProcessing, setIsProcessing] = useState(false);
	const [paypalUiStatus, setPaypalUiStatus] = useState<"idle" | "loading" | "rendered" | "error">("idle");
	const paypalInitializedRef = useRef(false);
	const paypalPaymentIdRef = useRef<string | null>(null);

	const { mutateAsync: createPaymentOrder } = useCreatePaymentOrderMutation();
	const { mutateAsync: completePayment } = useCompletePaymentOrderMutation();

	// ÌôòÏú® (KRW‚ÜíUSD) ‚Äì PayPal Í≤∞Ï†ú Ïãú ÌïÑÏöî
	const { data: exchangeRateData } = useQuery(useExchangeRateLatestQueryOptions("KRW", "USD"));
	const krwToUsdRate = exchangeRateData?.rate ?? null;

	const onHandleOpenChange = useCallback(
		(openState: boolean) => {
			onOpenChange(openState);

			// Î™®Îã¨Ïù¥ Îã´ÌûàÎ©¥ PayPal UI Ï¥àÍ∏∞Ìôî ÏÉÅÌÉúÎ•º Î¶¨ÏÖãÌï©ÎãàÎã§.
			if (!openState) {
				setSelectedMethod(null);
				paypalInitializedRef.current = false;
				setPaypalUiStatus("idle");

				// PayPal UI Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
				const paypalContainer = document.getElementById("portone-paypal-ui-container");
				if (paypalContainer) {
					paypalContainer.innerHTML = "";
				}
			}
		},
		[onOpenChange],
	);

	const { data: userMe } = useQuery(getUserMeQueryOption());

	/**
	 * Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ Ï≤òÎ¶¨Ìï©ÎãàÎã§.
	 * 1. Î∞±ÏóîÎìúÏóê Ï£ºÎ¨∏ ÏÉùÏÑ± ÏöîÏ≤≠
	 * 2. Ìè¨Ìä∏Ïõê Í≤∞Ï†ú ÏöîÏ≤≠
	 * 3. Î∞±ÏóîÎìúÏóê Í≤∞Ï†ú ÏôÑÎ£å Ï≤òÎ¶¨ ÏöîÏ≤≠
	 */
	const handlePaymentRequest = useCallback(async () => {
		if (!selectedMethod) {
			alert("Í≤∞Ï†ú ÏàòÎã®ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
			return;
		}

		setIsProcessing(true);

		try {
			// 1. Î∞±ÏóîÎìúÏóê Ï£ºÎ¨∏ ÏÉùÏÑ± ÏöîÏ≤≠
			// const paymentId = `payment-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
			const paymentId = `payment-${uuidv4()}`;

			console.log("Creating payment order:", { paymentId });

			const orderResponse = await createPaymentOrder({
				type: "CART",
				paymentId,
				currency: selectedMethod.method === "PAYPAL" ? "USD" : undefined,
				// cartItemIds ÏÉùÎûµÌïòÎ©¥ Ï†ÑÏ≤¥ Ïπ¥Ìä∏ ÏïÑÏù¥ÌÖúÏúºÎ°ú Í≤∞Ï†ú
			});

			console.log("Order created:", orderResponse);

			const currency = selectedMethod.method === "PAYPAL" ? PortOne.Entity.Currency.USD : PortOne.Entity.Currency.KRW;
			const rate = selectedMethod.method === "PAYPAL" ? (krwToUsdRate ?? 1) : 1;
			const scaleFactor = selectedMethod.method === "PAYPAL" ? 10 ** 2 : 1;

			const paymentResponse = await PortOne.requestPayment({
				storeId: PORTONE_STORE_ID,
				channelKey: PORTONE_CHANNEL_KEY.PAYMENT,
				paymentId: paymentId,
				orderName: orderName,
				totalAmount: total * rate * scaleFactor,
				currency,
				payMethod:
					selectedMethod.method === "CARD"
						? "CARD"
						: selectedMethod.method === "TRANSFER"
							? "TRANSFER"
							: selectedMethod.method === "PAYPAL"
								? "PAYPAL"
								: "CARD",
				// products: checkoutItems.map((item) => ({
				// 	id: item.productId.toString(),
				// 	name: item.title,
				// 	amount: Math.round(item.price * rate * scaleFactor),
				// 	quantity: 1,
				// })),
				customer: {
					fullName: userMe?.name,
					phoneNumber: userMe?.phoneNumber,
					email: userMe?.email,
					customerId: `hitbeatclub-${userMe?.id}`,
				},
				redirectUrl: `${window.location.origin}/payment/complete`,
				noticeUrls: [`${process.env.NEXT_PUBLIC_API_URL}/payment/webhook`],
			});

			console.log("Payment response:", paymentResponse);

			if (paymentResponse?.code && paymentResponse.code.startsWith("FAILURE")) {
				// Í≤∞Ï†ú Ïã§Ìå®
				throw new Error(paymentResponse.message || "Í≤∞Ï†úÍ∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
			}

			// 3. Î∞±ÏóîÎìúÏóê Í≤∞Ï†ú ÏôÑÎ£å Ï≤òÎ¶¨ ÏöîÏ≤≠
			console.log("Completing payment:", { paymentId });

			const completionResponse = await completePayment({
				paymentId,
			});

			console.log("Payment completed:", completionResponse);

			// ÏÑ±Í≥µ ÏΩúÎ∞± Ìò∏Ï∂ú
			onPaymentComplete?.(orderResponse.data);
		} catch (error) {
			console.error("Payment error:", error);

			const errorMessage =
				error instanceof AxiosError
					? error.response?.data.detail
					: error instanceof Error
						? error.message
						: "Í≤∞Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";

			onPaymentError?.({
				message: errorMessage,
				code: "PAYMENT_ERROR",
			});
		} finally {
			setIsProcessing(false);
		}
	}, [selectedMethod, checkoutItems, orderName, total, krwToUsdRate, onPaymentComplete, onPaymentError]);

	const handleMethodSelect = useCallback((method: PaymentMethod) => {
		setSelectedMethod(method);
	}, []);

	const resetPaymentState = useCallback(() => {
		setSelectedMethod(null);
		setSelectedEasyPayProvider(null);
	}, []);

	// Load PayPal Smart Payment Button UI when PayPal method selected
	useEffect(() => {
		const loadPaypalUI = async () => {
			if (paypalInitializedRef.current || selectedMethod?.method !== "PAYPAL") return;

			setPaypalUiStatus("loading");
			try {
				const paymentId = `payment-${uuidv4()}`;
				paypalPaymentIdRef.current = paymentId;

				// 1. Create order in backend (CART type)
				const orderResponse = await createPaymentOrder({
					type: "CART",
					paymentId,
					currency: "USD",
				});

				// 2. Render PayPal Smart Payment Button via PortOne SDK
				const usdAmount = krwToUsdRate ? Math.round(total * krwToUsdRate) : total;
				const rate = krwToUsdRate ?? 1;
				const usdScaleFactor = 10 ** 2;

				await PortOne.loadPaymentUI(
					{
						uiType: "PAYPAL_SPB",
						storeId: PORTONE_STORE_ID,
						channelKey: PORTONE_CHANNEL_KEY.PAYPAL,
						paymentId,
						orderName,
						totalAmount: usdAmount * usdScaleFactor,
						currency: PortOne.Entity.Currency.USD,
						// products: checkoutItems.map((item) => ({
						// 	id: item.productId.toString(),
						// 	name: item.title,
						// 	amount: Math.round(item.price * rate * usdScaleFactor),
						// 	quantity: 1,
						// })),
						customer: {
							fullName: userMe?.name,
							phoneNumber: userMe?.phoneNumber,
							email: userMe?.email,
							customerId: `hitbeatclub-${userMe?.id}`,
						},
					},
					{
						onPaymentSuccess: async (response: PaymentResponse) => {
							try {
								await completePayment({ paymentId });
								onPaymentComplete?.(orderResponse.data);
								onHandleOpenChange(false);
							} catch (e: any) {
								const msg = e instanceof AxiosError ? e.response?.data.detail : e?.message;
								onPaymentError?.({ message: msg || "PAYMENT_ERROR", code: "PAYMENT_ERROR" });
							}
						},
						onPaymentFail: (error: PaymentError) => {
							setPaypalUiStatus("error");
							paypalInitializedRef.current = false;

							// ÏóêÎü¨ Î∞úÏÉù Ïãú PayPal Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
							const paypalErrorContainer = document.getElementById("portone-paypal-ui-container");
							if (paypalErrorContainer) {
								paypalErrorContainer.innerHTML = "";
							}

							onPaymentError?.({ message: error.message, code: error.code || "PAYMENT_ERROR" });
						},
					},
				);

				paypalInitializedRef.current = true;
				setPaypalUiStatus("rendered");
			} catch (err: any) {
				setPaypalUiStatus("error");
				paypalInitializedRef.current = false;

				// ÏóêÎü¨ Î∞úÏÉù Ïãú PayPal Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
				const paypalErrorContainer = document.getElementById("portone-paypal-ui-container");
				if (paypalErrorContainer) {
					paypalErrorContainer.innerHTML = "";
				}

				const msg = err instanceof AxiosError ? err.response?.data?.detail : err?.message;
				onPaymentError?.({ message: msg || "PAYPAL_UI_ERROR", code: "PAYPAL_UI_ERROR" });
			}
		};

		void loadPaypalUI();
		// eslint-disable-next-line react-hooks/exhaustive-deps
	}, [selectedMethod]);

	/*
	 * PayPal ‚Üí Îã§Î•∏ Í≤∞Ï†ú ÏàòÎã®ÏúºÎ°ú Ï†ÑÌôò Ïãú PayPal UI Í¥ÄÎ†® ÏÉÅÌÉúÎ•º Î¶¨ÏÖãÌï©ÎãàÎã§.
	 * Îã§Ïãú PayPalÏùÑ ÏÑ†ÌÉùÌñàÏùÑ Îïå UIÍ∞Ä Ïû¨Î†åÎçîÎßÅÎêòÏßÄ ÏïäÎäî Î¨∏Ï†úÎ•º Î∞©ÏßÄÌï©ÎãàÎã§.
	 */
	useEffect(() => {
		if (selectedMethod?.method === "PAYPAL") return;

		paypalInitializedRef.current = false;
		setPaypalUiStatus("idle");

		const paypalContainer = document.getElementById("portone-paypal-ui-container");
		if (paypalContainer) {
			paypalContainer.innerHTML = "";
		}
	}, [selectedMethod]);

	useEffect(() => {
		if (!open) return;

		// Î™®Îã¨Ïù¥ ÏÉàÎ°ú Ïó¥Î¶¥ Îïå PayPal ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (ÏóêÎü¨ Î©îÏãúÏßÄ Ï†úÍ±∞)
		paypalInitializedRef.current = false;
		setPaypalUiStatus("idle");

		const paypalContainer = document.getElementById("portone-paypal-ui-container");
		if (paypalContainer) {
			paypalContainer.innerHTML = "";
		}
	}, [open]);

	return (
		<Popup.Popup
			open={open}
			onOpenChange={onHandleOpenChange}
		>
			<Popup.PopupContent className="w-[520px] max-h-[90vh]">
				<div className="max-h-[90vh] overflow-y-auto">
					<Popup.PopupHeader>
						<Popup.PopupTitle className="font-bold">Í≤∞Ï†ú ÏàòÎã® ÏÑ†ÌÉù</Popup.PopupTitle>
						<Popup.PopupDescription>
							{`Í≤∞Ï†úÌïòÏã§ Ï¥ù Í∏àÏï°ÏùÄ ${total.toLocaleString()}ÏõêÏûÖÎãàÎã§.\nÍ≤∞Ï†ú ÏàòÎã®ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`}
						</Popup.PopupDescription>
					</Popup.PopupHeader>

					<div
						className={cn(
							"grid gap-3 mt-4",
							paymentMethods.length > 4 || paymentMethods.length === 3 ? "grid-cols-3" : "grid-cols-2",
						)}
					>
						{paymentMethods.map((method) => (
							<button
								key={method.id}
								className={cn(
									"flex flex-col items-center justify-center p-4 border-2 rounded-[5px] cursor-pointer transition-all h-[100px]",
									selectedMethod?.id === method.id
										? "border-black bg-gray-100"
										: "border-gray-300 hover:border-gray-500",
								)}
								onClick={() => handleMethodSelect(method)}
							>
								<span className="mb-2 text-3xl">{method.icon}</span>
								<span className="font-bold text-[14px] font-suisse text-center">{method.name}</span>
							</button>
						))}
					</div>

					{/* PayPal UI Container */}
					{selectedMethod?.method === "PAYPAL" && (
						<div className="my-4">
							{paypalUiStatus === "loading" && (
								<div className="flex flex-col items-center justify-center p-4 text-center rounded-md bg-gray-50 min-h-[120px]">
									<svg
										className="w-8 h-8 mb-3 text-blue-500 animate-spin"
										xmlns="http://www.w3.org/2000/svg"
										fill="none"
										viewBox="0 0 24 24"
									>
										<circle
											className="opacity-25"
											cx="12"
											cy="12"
											r="10"
											stroke="currentColor"
											strokeWidth="4"
										></circle>
										<path
											className="opacity-75"
											fill="currentColor"
											d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
										></path>
									</svg>
									<p className="font-semibold">ÌéòÏù¥Ìåî Í≤∞Ï†ú Î≤ÑÌäºÏùÑ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§...</p>
								</div>
							)}

							<div
								id="portone-paypal-ui-container"
								className="portone-ui-container pc-cart-payment-select-modal flex justify-center w-full min-w-full"
								style={{ display: paypalUiStatus === "rendered" ? "flex" : "none" }}
							></div>

							{/* ÌôòÏú® Ï†ïÎ≥¥ ÌëúÏãú */}
							<p className="mt-3 text-xs text-center text-gray-500">
								{krwToUsdRate !== null
									? `1,000 KRW ‚âà ${(1000 * krwToUsdRate).toFixed(4)} USD`
									: "ÌôòÏú® Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë..."}
							</p>

							{paypalUiStatus === "error" && (
								<p className="mt-2 text-sm text-red-600 text-center">ÌéòÏù¥Ìåî Î≤ÑÌäº Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
							)}
						</div>
					)}

					<Popup.PopupFooter className="mt-6">
						<Popup.PopupButton
							className="text-black bg-white border-2 border-black"
							onClick={() => onHandleOpenChange(false)}
						>
							Ï∑®ÏÜå
						</Popup.PopupButton>
						{selectedMethod?.method !== "PAYPAL" && (
							<Popup.PopupButton
								onClick={handlePaymentRequest}
								disabled={
									!selectedMethod || (selectedMethod.method === "EASY_PAY" && !selectedEasyPayProvider) || isProcessing
								}
								className={cn(
									(!selectedMethod ||
										(selectedMethod.method === "EASY_PAY" && !selectedEasyPayProvider) ||
										isProcessing) &&
										"opacity-50 cursor-not-allowed",
								)}
							>
								{isProcessing ? "Í≤∞Ï†ú Ï≤òÎ¶¨ Ï§ë..." : "Í≤∞Ï†úÌïòÍ∏∞"}
							</Popup.PopupButton>
						)}
					</Popup.PopupFooter>
				</div>
			</Popup.PopupContent>
		</Popup.Popup>
	);
};
